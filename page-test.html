<html>

	<head>
		<link rel = "stylesheet" type = "text/css" href = "https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
		<style>
			textarea {
				white-space: pre-line;
			}
			body {
				margin: 20px;
			}			
			.clear-console {
				display: block;
			}
		</style>
		<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
	</head>

	<body>

		<textarea rows="10">Sample Sku's &#13;Gaming: 910-005099 &#13;Gaming: 910-004615 &#13; Sample theme&#13; 4852488000</textarea>
		
		<p>DR auth flow</p>		
		<button class="auth-token">Authorize</button>
		<br>
		<p> Cart operations </p>
		<input type="text" placeholder='sku' id="sku">
		<input type="text" placeholder='themeId' id="themeId">
		
		<input type="text" placeholder='lineItemId' id="lineItemId">
		<input type="text" placeholder='quantity' id="quantity">
		<input type="text" placeholder='action update/add/subtract based on quantity field' id="lineItemAction">
		
		<button class="add-to-cart" >add to cart</button>
		<button class="add-line-item" >add line item</button>
		<button class="get-cart" >get cart entries</button>
		<button class="delete-cart" >delete line item</button>
		
		<br><br>
		<p> View DR cart will work only in the accepted domains, so localhost wont work, for more information see the comments in the method implementation  </p>
		<a href="" class="view-cart" >view DR cart</a> 
		

		
		<br><br>
		<button class="clear-console">clear console</button>
		<textarea id="viewlog" cols="130" rows="40"></textarea>

		<script>
	
		var sessionTokenUrl = "https://buy.logitech.com/store/logib2c/SessionToken?format=json";
		var secretKey,
		tokenUrl,
		addToCartLink,
		addToCartLineItemLink,
		updateLineItemLink,
		getCartLink,
		deleteLineItemsLink,
		viewCartLink;
		//PROD
		tokenUrl = "https://www.logitech.com/bin/cart/create?action=authorize";
		addToCartLink = "https://www.logitech.com/bin/cart/create?action=updatecart";
		addToCartLineItemLink = "https://www.logitech.com/bin/cart/create?action=updatelineitems";
	   	getCartLink = "https://www.logitech.com/bin/cart/create?action=getcart";
		deleteLineItemsLink = "https://www.logitech.com/bin/cart/create?action=deletelineitems",
		viewCartLink = "https://www.logitech.com/bin/cart/view";
			
		//TEST
		/*tokenUrl = "http://api-cte-ext.digitalriver.com/oauth20/token";
		addToCartLink = "https://api-cte-ext.digitalriver.com/v1/shoppers/me/carts/active?siteSettingAttEnv=DESIGN&format=json";
		addToCartLineItemLink = "https://api-cte-ext.digitalriver.com/v1/shoppers/me/carts/active/line-items?siteSettingAttEnv=DESIGN&format=json"
		updateLineItemLink = "https://api-cte-ext.digitalriver.com/v1/shoppers/me/carts/active/line-items/{{RESPONSE-LineItemID}}/?siteSettingAttEnv=DESIGN&format=json"
		getCartLink = "https://api-cte-ext.digitalriver.com/v1/shoppers/me/carts/active?siteSettingAttEnv=DESIGN&format=json"*/
	
	
		var accessToken;
		
		var sessionToken;
		document.addEventListener('DOMContentLoaded', function(){
			let sessionTokenBtn = document.querySelector('.session-token');
			let authTokenBtn = document.querySelector('.auth-token');
			let addToCartBtn = document.querySelector('.add-to-cart');
			let addLineItemBtn = document.querySelector('.add-line-item');
			let getCartEntriesBtn = document.querySelector('.get-cart');
			let deleteCartBtn = document.querySelector('.delete-cart');
			
			let viewCartBtn = document.querySelector('.view-cart');
			// Fetch session token and then auth token
			authTokenBtn.addEventListener('click', function(){
				authorize();				
			});		
						
			addToCartBtn.addEventListener('click', function(){
				addToCart(sku.value, themeId.value);				
			});	
			
			addLineItemBtn.addEventListener('click', function(){
				addLineItem(sku.value, lineItemId.value, 'update', quantity.value);				
			});	
			
			getCartEntriesBtn.addEventListener('click', function(){
				getCartEntries();				
			});	
			
			deleteCartBtn.addEventListener('click', function(){
				deleteLineItems(lineItemId.value);				
			});	
			
			viewCartBtn.addEventListener('click', function(){
				//viewCart();				
			});	
		
		});		
		
		/** auth flow **/
		/*START*/
		function authorize() {	
			$.ajax({
				url: sessionTokenUrl,
				method: 'GET',
				success: function(data){
					sessionToken = data.session_token;
					retrieveToken(sessionToken)
				}
			});
		}		
		function retrieveToken(sessionToken){
			$.ajax({
					url: tokenUrl,
					method: 'GET',
					crossDomain: true,
					contentType: 'application/x-www-form-urlencoded',
					data: {
						'session_token': sessionToken,
						'locale': 'en-us'
					},
					success: function(data){
						accessToken = JSON.parse(data).drtoken;
						printToConsole(accessToken);
					},
					error: function(){
						console.log("Error during api call, reverting to old cart link");				
					}
			});
		}		
		/*END*/
		
		/** CART OPERATIONS **/
		/* START */
		function getCartEntries() {
			var ajaxData = {
				'dr_token': accessToken				
			}
			$.ajax({
					url: getCartLink+"&t="+new Date().getTime(),
					method: 'GET',
					crossDomain: true,
					contentType: 'text/plain',
					data: ajaxData,
					success: function(data){
						printToConsole(data)
					},
					error: function(){
						console.log("Error during api call, reverting to old cart link");				
					}
			});
		}
		
		function addToCart(skuId, themeId) {
			var ajaxData = {
				'sku_id': skuId || "910-005099",
				'theme_id': themeId || "4852488000",
				'dr_token': accessToken,
				'quantity': 1
			}
			$.ajax({
					url: addToCartLink,
					method: 'GET',
					crossDomain: true,
					contentType: 'application/x-www-form-urlencoded',
					data: ajaxData,
					success: function(data){
						printToConsole(data)
					},
					error: function(){
						console.log("Error during api call, reverting to old cart link");				
					}
			})
		}
		
		function addLineItem(skuId, lineItemId, lineItemAction, quantity) {
			var ajaxData = {
				'sku_id': skuId || "910-005099",
				'theme_id': "4852488000",
				'dr_token': accessToken,
				'quantity': quantity || 1
			}
			
			if(lineItemId) {
				ajaxData = {
					'sku_id': skuId || "910-005099",
					'theme_id': "4852488000",
					'dr_token': accessToken,
					'quantity': quantity || 1,
					'lineitem_id': lineItemId,
					'lineitem_action': lineItemAction || 'update'						
				}				
			}
			
			$.ajax({
					url: addToCartLineItemLink,
					method: 'GET',
					crossDomain: true,
					contentType: 'application/x-www-form-urlencoded',
					data: ajaxData,
					success: function(data){
						printToConsole(data)
					},
					error: function(){
						console.log("Error during api call, reverting to old cart link");				
					}
			})
		}
		
		function deleteLineItems(lineItemId) {
			var ajaxData = {
				'dr_token': accessToken				
			}
			if(lineItemId){
				ajaxData = {
					'dr_token': accessToken,
					'lineitem_id': lineItemId
				}
			}
			$.ajax({
					url: deleteLineItemsLink,
					method: 'GET',
					crossDomain: true,
					contentType: 'application/x-www-form-urlencoded',
					data: ajaxData,
					success: function(data, textStatus, xhr){
						if(xhr.status == 204) {
							printToConsole("Data deleted")
						}						
					},
					error: function(){
						console.log("Error during api call, reverting to old cart link");				
					}
			})
		}
		function viewCart() {
			// its a redirect to the cart page due to domain restrictions on the redirect this wont work on localhost
			// alternate way to test it is construct the url and paste it in the browser
						
			var ajaxData = {
				'themeId': "4852488000",
				'drToken': accessToken
			}
			$.ajax({
					url: viewCartLink,
					method: 'GET',
					crossDomain: true,
					contentType: 'application/x-www-form-urlencoded',
					data: ajaxData,
					success: function(data){
						console.log(data)
					},
					error: function(){
						console.log("Error during api call, reverting to old cart link");				
					}
			})
		}
		
		function formData(requestBody){
			let formBody = [];
			for (var property in requestBody) {
			  var encodedKey = encodeURIComponent(property);
			  var encodedValue = encodeURIComponent(requestBody[property]);
			  formBody.push(encodedKey + "=" + encodedValue);
			}
			formBody = formBody.join("&");
			return formBody;
		}		
		
		function printToConsole(cartEntry){
			if(cartEntry.length > 1){
				viewlog.innerHTML = JSON.stringify(cartEntry, undefined, 4) + "&#13;&#010;";
			} else {
				viewlog.innerHTML = JSON.stringify(cartEntry, undefined, 4) + "&#13;&#010;";
			}
			console.log(cartEntry)
		}
		
		function setDRToken(token) {
			accessToken = token;
		}
		
		

		</script>
	</body>

</html>